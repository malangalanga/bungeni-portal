<?xml version="1.0"?>
<workflow id="motion_workflow" 
    title="Motion Workflow" 
    description="A Motion" 
    domain="bungeni.ui"
    initial_state="">
    
    <!-- Workflow XML Source Style Guide
    
    States
    
    - permission are organized by target type, with each set of assignments
      for a target type being indicated within a comment to marke the start 
      of each such section.
    
    - within each target-section, the order of appearance of permission actions 
      (for appropriate actions) is:
        View
        Edit
        Add
        Delete
    
    - for each single permission, the order of assigment to each appropriate 
      role follows the following order:
        <role id="bungeni.Clerk" title="Clerks Office" />
        <role id="bungeni.Speaker" title="Speaker Office" />
        <role id="bungeni.Owner" title="Owner" />
        <role id="bungeni.MP" title="Member of parliament" />
        <role id="bungeni.Minister" title="Minister" />
        <role id="bungeni.Everybody" title="All authenticated users" />
        <role id="bungeni.Anybody" title="Bungeni Visitor" />
    
    - for a motion, the MP is also the Owner.
    
    - denying zope.View on a Role seems to deny every other permission !+??
    
    - the root element id should not contain "-" (use "_" as separator).
    
    Transitions
    
    - the order of attributes should respect:
        id 
        title
        source
        destination
        condition=NullCondition
        action=NullAction
        trigger=MANUAL
        permission=CheckerPublic
        order=0
        event=None
        require_confirmation=False
        
    
    NOTE: to easily see the the evaluated result of all permission assigments 
    for each workflow state definition (that uses like_state) set the 
    logging level to DEBUG.
    -->
    
    <state id="working_draft" title="Working Draft">
        <!-- motion -->
        <grant permission="zope.View" role="bungeni.Clerk" />
        <grant permission="zope.View" role="bungeni.Speaker" />
        <deny permission="zope.View" role="bungeni.Owner" />
        <deny permission="zope.View" role="bungeni.MP" />
        <deny permission="zope.View" role="bungeni.Minister" />
        <deny permission="zope.View" role="bungeni.Everybody" />
        <deny permission="zope.View" role="bungeni.Anybody" />
        <grant permission="bungeni.motion.Edit" role="bungeni.Clerk" />
        <grant permission="bungeni.motion.Edit" role="bungeni.Speaker" />
        <deny permission="bungeni.motion.Edit" role="bungeni.Owner" />
        <deny permission="bungeni.motion.Edit" role="bungeni.MP" />
        <deny permission="bungeni.motion.Edit" role="bungeni.Minister" />
        <deny permission="bungeni.motion.Edit" role="bungeni.Everybody" />
        <deny permission="bungeni.motion.Edit" role="bungeni.Anybody" />
        <grant permission="bungeni.motion.Delete" role="bungeni.Clerk" />
        <grant permission="bungeni.motion.Delete" role="bungeni.Speaker" />
        <deny permission="bungeni.motion.Delete" role="bungeni.Owner" />
        <deny permission="bungeni.motion.Delete" role="bungeni.MP" />
        <deny permission="bungeni.motion.Delete" role="bungeni.Minister" />
        <deny permission="bungeni.motion.Delete" role="bungeni.Everybody" />
        <deny permission="bungeni.motion.Delete" role="bungeni.Anybody" />
        <!-- cosignatory -->
        <grant permission="bungeni.cosignatory.Add" role="bungeni.Clerk" />
        <grant permission="bungeni.cosignatory.Add" role="bungeni.Speaker" />
        <deny permission="bungeni.cosignatory.Add" role="bungeni.Owner" />
        <deny permission="bungeni.cosignatory.Add" role="bungeni.MP" />
        <deny permission="bungeni.cosignatory.Add" role="bungeni.Minister" />
        <deny permission="bungeni.cosignatory.Add" role="bungeni.Everybody" />
        <deny permission="bungeni.cosignatory.Add" role="bungeni.Anybody" />
        <grant permission="bungeni.cosignatory.Delete" role="bungeni.Clerk" />
        <grant permission="bungeni.cosignatory.Delete" role="bungeni.Speaker" />
        <deny permission="bungeni.cosignatory.Delete" role="bungeni.Owner" />
        <deny permission="bungeni.cosignatory.Delete" role="bungeni.MP" />
        <deny permission="bungeni.cosignatory.Delete" role="bungeni.Minister" />
        <deny permission="bungeni.cosignatory.Delete" role="bungeni.Everybody" />
        <deny permission="bungeni.cosignatory.Delete" role="bungeni.Anybody" />
        <!-- fileattachment -->
        <grant permission="bungeni.fileattachment.Edit" role="bungeni.Clerk" />
        <grant permission="bungeni.fileattachment.Edit" role="bungeni.Speaker" />
        <deny permission="bungeni.fileattachment.Edit" role="bungeni.Owner" />
        <deny permission="bungeni.fileattachment.Edit" role="bungeni.MP" />
        <deny permission="bungeni.fileattachment.Edit" role="bungeni.Minister" />
        <deny permission="bungeni.fileattachment.Edit" role="bungeni.Everybody" />
        <deny permission="bungeni.fileattachment.Edit" role="bungeni.Anybody" />
        <grant permission="bungeni.fileattachment.Add" role="bungeni.Clerk" />
        <grant permission="bungeni.fileattachment.Add" role="bungeni.Speaker" />
        <deny permission="bungeni.fileattachment.Add" role="bungeni.Owner" />
        <deny permission="bungeni.fileattachment.Add" role="bungeni.MP" />
        <deny permission="bungeni.fileattachment.Add" role="bungeni.Minister" />
        <deny permission="bungeni.fileattachment.Add" role="bungeni.Everybody" />
        <deny permission="bungeni.fileattachment.Add" role="bungeni.Anybody" />
    </state>
    
    <state id="draft" like_state="working_draft" title="Draft">
        <!-- motion -->
        <deny permission="zope.View" role="bungeni.Clerk" />
        <deny permission="zope.View" role="bungeni.Speaker" />
        <grant permission="zope.View" role="bungeni.Owner" />
        <deny permission="bungeni.motion.Edit" role="bungeni.Clerk" />
        <deny permission="bungeni.motion.Edit" role="bungeni.Speaker" />
        <grant permission="bungeni.motion.Edit" role="bungeni.Owner" />
        <deny permission="bungeni.motion.Delete" role="bungeni.Clerk" />
        <deny permission="bungeni.motion.Delete" role="bungeni.Speaker" />
        <grant permission="bungeni.motion.Delete" role="bungeni.Owner" />
        <!-- cosignatory -->
        <deny permission="bungeni.cosignatory.Add" role="bungeni.Clerk" />
        <deny permission="bungeni.cosignatory.Add" role="bungeni.Speaker" />
        <grant permission="bungeni.cosignatory.Add" role="bungeni.Owner" />
        <deny permission="bungeni.cosignatory.Delete" role="bungeni.Clerk" />
        <deny permission="bungeni.cosignatory.Delete" role="bungeni.Speaker" />
        <grant permission="bungeni.cosignatory.Delete" role="bungeni.Owner" />
        <!-- fileattachment -->
        <deny permission="bungeni.fileattachment.Add" role="bungeni.Clerk" />
        <deny permission="bungeni.fileattachment.Add" role="bungeni.Speaker" />
        <grant permission="bungeni.fileattachment.Add" role="bungeni.Owner" />
        <deny permission="bungeni.fileattachment.Edit" role="bungeni.Clerk" />
        <deny permission="bungeni.fileattachment.Edit" role="bungeni.Speaker" />
        <grant permission="bungeni.fileattachment.Edit" role="bungeni.Owner" />
    </state>
    
    <state id="submitted" title="Submitted" like_state="draft">
        <!-- motion -->
        <grant permission="zope.View" role="bungeni.Clerk" />
        <grant permission="zope.View" role="bungeni.Speaker" />
        <deny permission="bungeni.motion.Edit" role="bungeni.Owner" />
        <deny permission="bungeni.motion.Delete" role="bungeni.Owner" />
        <!-- cosignatory -->
        <deny permission="bungeni.cosignatory.Add" role="bungeni.Owner" />
        <deny permission="bungeni.cosignatory.Delete" role="bungeni.Owner" />
        <!-- fileattachment -->
        <deny permission="bungeni.fileattachment.Add" role="bungeni.Owner" />
        <deny permission="bungeni.fileattachment.Edit" role="bungeni.Owner" />
    </state>
    
    <state id="received" like_state="submitted"
        title="Received by Clerks Office">
        <!-- motion -->
        <grant permission="bungeni.motion.Edit" role="bungeni.Clerk" />
        <!-- cosignatory -->
        <grant permission="bungeni.cosignatory.Add" role="bungeni.Clerk" />
        <grant permission="bungeni.cosignatory.Delete" role="bungeni.Clerk" />
        <!-- fileattachment -->
        <grant permission="bungeni.fileattachment.Edit" role="bungeni.Clerk" />        
        <grant permission="bungeni.fileattachment.Add" role="bungeni.Clerk" />
    </state>
    
    <state id="clarify_mp" like_state="submitted"
        title="Needs Clarification by MP">
        <!-- motion -->
        <grant permission="bungeni.motion.Edit" role="bungeni.Owner" />
        <!-- cosignatory -->
        <grant permission="bungeni.cosignatory.Add" role="bungeni.Owner" />
        <grant permission="bungeni.cosignatory.Delete" role="bungeni.Owner" />
        <!-- fileattachment -->
        <grant permission="bungeni.fileattachment.Edit" role="bungeni.Owner" />
        <grant permission="bungeni.fileattachment.Add" role="bungeni.Owner" />
    </state>
    
    <state id="complete" like_state="submitted"
        title="Submitted to the Speaker">
        <!-- motion -->
        <grant permission="bungeni.motion.Edit" role="bungeni.Speaker" />
        <!-- cosignatory -->
        <grant permission="bungeni.cosignatory.Add" role="bungeni.Speaker" />
        <grant permission="bungeni.cosignatory.Delete" role="bungeni.Speaker" />
        <!-- fileattachment -->
        <grant permission="bungeni.fileattachment.Edit" role="bungeni.Speaker" />
        <grant permission="bungeni.fileattachment.Add" role="bungeni.Speaker" />
    </state>
    
    <state id="clarify_clerk" like_state="received"
        title="Needs Clarification by Clerks Office" />
    
    <state id="withdrawn" like_state="submitted" title="Withdrawn" />
    
    <state id="inadmissible" like_state="submitted" title="Inadmissible" />
    
    <state id="admissible" like_state="submitted" title="Admissible">
        <!-- motion -->
        <grant permission="zope.View" role="bungeni.MP" />
        <grant permission="zope.View" role="bungeni.Minister" />
        <grant permission="zope.View" role="bungeni.Everybody" />
        <grant permission="zope.View" role="bungeni.Anybody" />
    </state>
    
    <state id="schedule_pending" like_state="admissible" 
        title="Schedule pending" />
    
    <state id="scheduled" like_state="admissible" title="Scheduled" />
    
    <!-- admissable motion that cannot be debated -->
    <state id="deferred" like_state="admissible" title="Deferred" />
    
    <!--motion was scheduled for but droped, becuase no show of MP etc -->
    <state id="dropped" like_state="admissible" title="Dropped" />
    
    <state id="adopted" like_state="admissible" title="Adopted" />
    
    <state id="adopted_amendments" like_state="admissible"
        title="Adopted with amendments" />
    
    <state id="rejected" like_state="admissible" title="Rejected"/>
    
    <!--defered motion that was not debated -->
    <state id="elapsed" like_state="admissible" title="Elapsed" />
    
    <!--a motion was debated and the debate adjourned  -->
    <state id="debate_adjourned" like_state="admissible" 
        title="Debate adjourned" />
    
    <state id="withdrawn_public" like_state="admissible" 
        title="Withdrawn" />
    
    
    <!--
    
    transitions: order of attributes:
        id 
        title
        source
        destination
        condition=NullCondition
        action=NullAction
        trigger=MANUAL
        permission=CheckerPublic
        order=0
        event=None
        require_confirmation=False
    
    !+ACTION remove this out of the XML, function of transition
    -->
    
    <transition id="create"
        title="Create Motion"
        source=""
        destination="draft"
        condition="bungeni.core.workflows.utils.conditions.user_is_context_owner"
        action="bungeni.core.workflows.motion.actions.create"
        trigger="automatic"
        permission="bungeni.motion.Add"
    />
    
    <transition id="create_on_behalf_of"
        title="Create Motion (On behalf of)"
        source=""
        destination="working_draft"
        condition="bungeni.core.workflows.utils.conditions.user_is_not_context_owner"
        action="bungeni.core.workflows.motion.actions.create"
        trigger="automatic"
        permission="bungeni.motion.Add"
    />
    
    <transition id="submit"
        title="Submit to Clerk" 
        source="working_draft draft" 
        destination="submitted" 
        condition=""
        action="bungeni.core.workflows.motion.actions.submit" 
        trigger="manual"
        permission="bungeni.motion.wf.submit"
        event="bungeni.core.workflows.interfaces.IMotionSubmittedEvent"
    />
    
    <transition id="receive" 
        title="Receive" 
        source="submitted"
        destination="received" 
        condition=""
        action="bungeni.core.workflows.motion.actions.receive" 
        trigger="manual" 
        permission="bungeni.motion.wf.receive"
        event="bungeni.core.workflows.interfaces.IMotionReceivedEvent"
    />
    
    
    
    
    
    <transition id="require_edit_by_mp" 
        title="Needs Clarification by MP"
        source="received" 
        destination="clarify_mp" permission="bungeni.motion.wf.return_to_owner"
        condition=""
        action="bungeni.core.workflows.motion.actions.require_edit_by_mp" 
        trigger="manual"
        event="bungeni.core.workflows.interfaces.IMotionClarifyEvent" 
        require_confirmation="true"
    />

 
    <transition id="complete" title="Submit to the Speaker Office" trigger="manual"
        source="received" destination="complete" permission="bungeni.motion.wf.submit_to_reviewer2"
        action="bungeni.core.workflows.motion.actions.complete" condition="" />

   
    <transition id="approve" title="Approve" trigger="manual" source="complete"
        destination="admissible" permission="bungeni.motion.wf.approve"
        action="bungeni.core.workflows.motion.actions.approve" condition="" />

   

    <transition id="allow_schedule" title="Make available for scheduling" trigger="manual"
        source="admissible deferred debate_adjourned" destination="schedule_pending"
        permission="bungeni.motion.wf.schedule_pending" action=""
        event="bungeni.core.workflows.interfaces.IMotionPendingEvent" />


   
    <transition id="reject" title="Reject" trigger="manual" source="complete"
        destination="inadmissible" permission="bungeni.motion.wf.reject"
        action="bungeni.core.workflows.motion.actions.reject" condition=""
        event="bungeni.core.workflows.interfaces.IMotionRejectedEvent" require_confirmation="true" />

 
    <transition id="require_amendment" title="Needs Clarification" trigger="manual"
        source="complete" destination="clarify_clerk" permission="bungeni.motion.wf.return_to_reviewer"
        action="bungeni.core.workflows.motion.actions.require_amendment" condition=""
        require_confirmation="true" />

   
    <transition id="complete_clarify" title="Complete" trigger="manual" source="clarify_clerk"
        destination="complete" permission="bungeni.motion.wf.mark_complete" action="" condition="" />

  
    <transition id="mp_clarify" title="Needs Clarification by MP" trigger="manual"
        source="clarify_clerk" destination="clarify_mp" permission="bungeni.motion.wf.return_to_owner"
        action="bungeni.core.workflows.motion.actions.mp_clarify" condition=""
        event="bungeni.core.workflows.interfaces.IMotionClarifyEvent" require_confirmation="true" />

   
    <transition id="resubmit_clerk" title="Resubmit to clerk" trigger="manual" source="clarify_mp"
        destination="submitted" permission="bungeni.motion.wf.submit_to_reviewer"
        action="bungeni.core.workflows.motion.actions.submit" condition="" />

   
    <transition id="defer" title="Defer" trigger="manual" source="admissible" destination="deferred"
        permission="bungeni.motion.wf.defer" action="bungeni.core.workflows.motion.actions.defer"
        condition="" event="bungeni.core.workflows.interfaces.IMotionDeferredEvent" />

   
    <transition id="elapse_defered" title="Elapse" trigger="manual" source="deferred"
        destination="elapsed" permission="bungeni.motion.wf.mark_elapse"
        action="bungeni.core.workflows.motion.actions.elapse" condition=""
        require_confirmation="true" />

    
    <transition id="schedule" title="Schedule" trigger="system" source="schedule_pending"
        destination="scheduled" permission="bungeni.motion.wf.schedule"
        action="bungeni.core.workflows.motion.actions.schedule"
        condition="bungeni.core.workflows.motion.conditions.is_scheduled"
        event="bungeni.core.workflows.interfaces.IMotionScheduledEvent" />

   
    <transition id="reschedule" title="Reschedule" trigger="system" source="scheduled"
        destination="schedule_pending" permission="bungeni.motion.wf.schedule_pending" condition="" />

   
    <transition id="revert_to_admissible" title="Revert to admissible" trigger="manual"
        source="schedule_pending" destination="admissible" permission="bungeni.motion.wf.approve"
        action="bungeni.core.workflows.motion.actions.revert_to_admissible" condition="" />

   
    <transition id="drop" title="Drop" trigger="manual" source="scheduled" destination="dropped"
        permission="bungeni.motion.wf.drop" action="" condition=""
        event="bungeni.core.workflows.interfaces.IMotionDroppedEvent" />

   
    <transition id="continue_debate" title="Debate adjourned" trigger="manual" source="scheduled"
        destination="debate_adjourned" permission="bungeni.motion.wf.adjourn_debate" condition="" event="" />

   
    <transition id="withdraw" title="Withdraw" trigger="manual"
        source="submitted
                received
                complete
                clarify_mp"
        destination="withdrawn" permission="bungeni.motion.wf.withdraw"
        action="bungeni.core.workflows.motion.actions.withdraw" condition=""
        require_confirmation="true" />

   
    <transition id="withdraw_public" title="Withdraw" trigger="manual"
        source="admissible
                scheduled
                deferred
                debate_adjourned
                schedule_pending"
        destination="withdrawn_public" permission="bungeni.motion.wf.withdraw"
        action="bungeni.core.workflows.motion.actions.withdraw" condition=""
        require_confirmation="true" />

   
    <transition id="adopt" title="Adopt" trigger="manual" source="scheduled" destination="adopted"
        permission="bungeni.motion.wf.adopt"
        action="bungeni.core.workflows.motion.actions.adopt" condition=""
        event="bungeni.core.workflows.interfaces.IMotionAdoptedEvent" require_confirmation="true" />

   
    <transition id="adopt_amendments" title="Adopt with amendments" trigger="manual"
        source="scheduled" destination="adopted_amendments" permission="bungeni.motion.wf.adopt"
        action="bungeni.core.workflows.motion.actions.adopt" condition=""
        event="bungeni.core.workflows.interfaces.IMotionAdoptedEvent" require_confirmation="true" />


    <transition id="scheduled_reject" title="Reject" trigger="manual" source="scheduled"
        destination="rejected" permission="bungeni.motion.wf.reject"
        action="bungeni.core.workflows.motion.actions.reject" condition=""
        event="bungeni.core.workflows.interfaces.IMotionRejectedEvent" require_confirmation="true" />

</workflow>

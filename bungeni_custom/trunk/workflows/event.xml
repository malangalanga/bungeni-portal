<?xml version="1.0"?>
<workflow title="Event Workflow"
    description="Workflow for base Event"
    permission_actions=".View .Edit .Add .Delete"
    >
    
    <!-- sub-item: NO global grants -->
    
    <!-- features -->
    <feature name="audit" enabled="true" />
    <feature name="version" enabled="true" />
    <feature name="attachment" enabled="true" />
    
    <!-- FACETS -->
    <!-- fz: a recommendation for simple management of "child-documents" 
    (events/attachments) facets. 
    
    We have "parent facets" (facets intended only for use by parent type) where 
    you just handle who has the right to "add" a "child-document" and we have 
    "workflow facets" (for this workflow) where you handle 
    (as in any document) the permission of the "child document".
    In these facets you should not use the ".Add" action.
    
    Please also note that for the "event" feature we may specify a facet per 
    event type we specify, in the following manner:
        <facet ref="event#{event_type_key}.{facet_name}" />
    That, for the default "event" type, the above would therefore become:
        <facet ref="event#event.{facet_name}" />
    Or, simply (as this is the default case):
        <facet ref="event.{facet_name}" />
    -->
    
    <!-- parent facets -->
    <facet name="add_clerk">
        <allow permission=".Add" roles="ClerkSenate ClerkAssembly" />
        <allow permission=".View" roles="ClerkSenate ClerkAssembly" />
        <allow permission=".Edit" roles="ClerkSenate ClerkAssembly" />
    </facet>
    <facet name="add_speaker">
        <allow permission=".Add" roles="SpeakerSenate SpeakerAssembly" />
        <allow permission=".View" roles="SpeakerSenate SpeakerAssembly" />
        <allow permission=".Edit" roles="SpeakerSenate SpeakerAssembly" />
    </facet>
    
    <!-- workflow facets -->
    <facet name="state_draft">
        <allow permission=".View" roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly" />
        <allow permission=".Edit" roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly" />
        <allow permission=".Delete" roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly" />
    </facet>
    <facet name="state_internal" default="true">
        <allow permission=".View" roles="Authenticated" />
        <allow permission=".Edit" roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly" />
    </facet>
    <facet name="state_withdrawn">
        <allow permission=".View" roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly" />
    </facet>
    
	<!-- !+child workflows rework:
	    - <state> @permissions_from_parent to @permissions_decided_by_parent ?
	    - all facet names starting with "state_", dropping this prefix
	    - option to allow a single in-palce anonymous facet within a state
	-->

    <!-- workflow states -->
    <state id="draft" title="Draft"> 
	    <facet ref=".state_draft" />
    </state>
	<state id="bound_to_parent" title="Visible (Parent)" permissions_from_parent="true" />
    <state id="internal" title="Internal">
        <facet ref=".state_internal" />
    </state>
    <state id="withdrawn" title="Withdrawn">
        <facet ref=".state_withdrawn" />
    </state>
    
    <!-- workflow transision -->    
    <transition title="Create"
        source=""
        destination="draft"
        trigger="automatic"
    />
    <transition title="Visible as Parent"
        source="draft internal"
        destination="bound_to_parent"
        trigger="manual"
        roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly"
        require_confirmation="false"
    />
    <transition title="Visible Internally"
        source="draft bound_to_parent"
        destination="internal"
        trigger="manual"
        roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly"
        require_confirmation="false"
    />
    <transition title="Withdraw"
        source="internal bound_to_parent"
        destination="withdrawn"
        trigger="manual"
        roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly"
        require_confirmation="false"
    />

</workflow>

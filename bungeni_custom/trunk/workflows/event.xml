<?xml version="1.0"?>
<workflow title="Event Workflow"
    description="Workflow for base Event"
    tags="draft private public"
    permission_actions=".View .Edit .Add .Delete"
    >
    
    <!-- sub-item, so should have NO "global" grants here -> should be 
    responsibility of the "owning" document's workflow e.g. it is that workflow
    that must declare who (and in which states) has the permission '.Add'.
    -->
    
    <!-- global grants -->
    <allow permission=".View" roles="Owner" />
    
    
    <!-- features -->
    <feature name="audit" enabled="true" />
    <feature name="version" enabled="true" />
    
    <!-- NOTE on Feature Facet Permissions: Sub-item permissions (apart from the
    Add permission, that is by defn unbound to an *existing* item) that are 
    allowed within a *feature facet* apply only for when the (workflowed, always)
    sub-item itself is in a permissions_from_parent="true" state. -->
    <feature name="attachment" enabled="true">
        <facet name="draft_Owner">
            <allow permission="attachment.View" roles="Owner" />
            <allow permission="attachment.Edit" roles="Owner" />
            <allow permission="attachment.Add" roles="Owner" />
        </facet>
        <facet name="internal">
            <allow permission="attachment.View" roles="Authenticated" />
            <allow permission="attachment.Edit" roles="Clerk" />
            <allow permission="attachment.Add" roles="Clerk" />
        </facet>
        <facet name="internal_terminal">
            <allow permission="attachment.View" roles="Authenticated" />
        </facet>
    </feature>
    
    
    <!-- workflow facets -->
    <facet name="draft_Owner">
        <allow permission=".Edit" roles="Owner" />
        <allow permission=".Delete" roles="Owner" />
    </facet>
    <facet name="internal">
        <allow permission=".View" roles="Authenticated" />
        <allow permission=".Edit" roles="Clerk Speaker" />
    </facet>
    <facet name="all_view">
        <allow permission=".View" roles="Authenticated" />
    </facet>
    
    
    <state id="draft" title="Draft Event" tags="draft private">
        <facet ref=".draft_Owner" />
        <facet ref="attachment.draft_Owner" />
    </state>
    
    <state id="attached" title="Event" permissions_from_parent="true" tags="public" />
    <!-- !+event.attachment(mr, dec-2012) NOTE that when an attachment (on this 
    event) is in the "attached" state AND the this event itself is in the "attached" 
    state then the HEAD doc handles all permissions (including all attachment-related 
    permissions). But, the HEAD doc (in all likeliness) also directly supports
    attachments and the workflow defines all the permissions for it, and (when both 
    this event and a sub-attachment are both in "attached" state) there is 
    NO DISTINCTION between permissions on direct attachments on HEAD doc or 
    the attachments on THIS event!
    -->

    
    <state id="internal" title="Published Internal">
        <facet ref=".internal" />
        <facet ref="attachment.internal" />
    </state>
    
    <!-- !+inactive(mr, aug-2011) review usage and rename across the board
        currently being used in attachment, heading, event
        consider using "dropped", "obsoleted", "removed"...
    -->
    <state id="inactive" title="Inactive event">
        <facet ref=".all_view" />
        <facet ref="attachment.internal_terminal" />
    </state>
    
    
    <!-- !+IDENTICAL_TRANSITIONS(mr, sep-2011) attachment, address, event -->
    <!-- 
    When adding a child item to a parent item that is NOT in draft, we 
    take safer route of creating the sub-item in draft. But, as a simple 
    convenience for the common case of adding a child item to a parent that
    IS in draft, we simply jump to the more natural "parent-bound" state.
    -->
    <transition title="Create"
        source=""
        destination="draft"
        condition="context_parent_is_not_draft"
        trigger="automatic"
    />
    <transition title="Create"
        source=""
        destination="attached"
        condition="context_parent_is_draft"
        trigger="automatic"
    />
    
    <transition title="Publish"
        source="draft"
        destination="attached"
        trigger="manual"
        roles="Owner"
    />
    
    <transition title="Publish Internal"
        source="draft"
        destination="internal"
        trigger="manual"
        roles="Owner"
    />
    
    <transition title="Re-publish"
        source="internal"
        destination="attached"
        trigger="manual"
        roles="Clerk Owner"
    />
    
    <!-- 
    if the parent has been published (i.e. is public, assuming that once 
    published it is never retracted) we do not want to allow transitioning away 
    from "attached".
    -->
    <transition title="Publish Internal"
        source="attached"
        destination="internal"
        condition="context_parent_is_not_public"
        trigger="manual"
        roles="Clerk Owner"
    />
    
    <transition title="Deactivate"
        source="attached internal"
        destination="inactive"
        condition="context_parent_is_not_public"
        trigger="manual"
        roles="Clerk Owner"
        require_confirmation="true"
    />

</workflow>

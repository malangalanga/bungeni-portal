<?xml version="1.0"?>
<workflow title="Attachment Workflow"
    description="Workflow for attachments"
    permission_actions=".View .Edit .Add .Delete"
    >
    
    <!-- sub-item: NO global grants -->
    
    <!-- features -->
    <feature name="audit" enabled="true" />
    <feature name="version" enabled="true" />
    
    <!-- FACETS -->
    <!-- fz: a recommendation for simple management of "child-documents" 
    (events/attachments) facets. 
    
    We have "parent facets" (facets intended only for use by parent type) where 
    you just handle who has the right to "add" a "child-document" and we have 
    "workflow facets" (for this workflow AND for parent) where you handle 
    (as in any document) the permission of the "child document".
    In these facets you should not use the ".Add" action.
    -->
    
    <!-- parent facets -->
    <facet name="add_drafter">
        <allow permission=".Add" roles="Drafter" />
    </facet>  
    <facet name="add_clerk">
        <allow permission=".Add" roles="ClerkSenate ClerkAssembly" />
    </facet>
    <facet name="add_speaker">
        <allow permission=".Add" roles="SpeakerSenate SpeakerAssembly" />
    </facet>
    
    <!-- workflow facets -->
    <facet name="state_draft">
        <allow permission=".View" roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly Owner" />
        <allow permission=".Edit" roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly" />
        <allow permission=".Delete" roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly" />
    </facet>
    <facet name="state_internal" default="true">
        <allow permission=".View" roles="Authenticated" />
        <allow permission=".Edit" roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly" />
    </facet>
    <facet name="state_as_parent">
        <allow permission=".View" roles="Anonymous" />
        <allow permission=".Edit" roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly" />
    </facet>
    <facet name="state_withdrawn">
        <allow permission=".View" roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly" />
    </facet>   
    
    <!-- workflow states -->
    <state id="draft" title="Draft">
        <facet ref=".state_draft" />
    </state>
    <!-- gives an error "your account is not authorized to view this item"
	<state id="as_parent" title="Visible as Parent" permissions_from_parent="true" /> -->
    <state id="as_parent" title="Visible as Parent">
        <facet ref=".state_as_parent" />
    </state>
    <state id="internal" title="Internal">
        <facet ref=".state_internal" />
    </state>
    <state id="withdrawn" title="Withdrawn">
        <facet ref=".state_withdrawn" />
    </state>
    
    <!-- workflow transision -->    
    <transition title="Create"
        source=""
        destination="draft"
        trigger="automatic"
    />

    <!-- flavio: remove owner once "as parent works -->   
    <transition title="Visible as Parent"
        source="draft internal"
        destination="as_parent"
        trigger="manual"
        roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly Owner"
        require_confirmation="false"
    />
    <transition title="Visible Internally"
        source="draft as_parent"
        destination="internal"
        trigger="manual"
        roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly"
        require_confirmation="false"
    />
    <transition title="Withdraw"
        source="internal as_parent"
        destination="withdrawn"
        trigger="manual"
        roles="ClerkSenate ClerkAssembly SpeakerSenate SpeakerAssembly"
        require_confirmation="false"
    />

</workflow>
